<!doctype html>
<html lang="cs" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DC ELO žebříček</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
<header>
  <div class="wrap">
    <div class="headerLeft">
      <div class="logo">
        <img id="logoImg" src="logo.png" alt="Logo" />
      </div>
      <div>
        <h1>DC ELO žebříček</h1>
        <div class="subtitle">by <a href="https://grailseries.cz/" target="_blank" rel="noopener noreferrer" class="grail-link">GRAIL SERIES</a></div>
        <div class="credit muted">
          Tento projekt přináší ELO hodnocení pro Duel Commander komunitu. Naším cílem je spravedlivě hodnotit výkony hráčů, podpořit soutěživost a nabídnout přehledný dlouhodobý žebříček.
        </div>
        <div class="credit muted">
          Nechcete mít na webu uvedené své jméno? <a class="inlineLink" id="anonLink" href="#">Klikněte sem</a>.
        </div>
      </div>
    </div>

    <div class="headerRight">
      
      <div class="headerRightTop">
        <button class="btnSupport" id="supportBtn" type="button" aria-label="Podpořit" title="Podpořit">
          <span class="btnSupportIcon" aria-hidden="true">★</span>
          <span class="btnSupportText">Podpořit</span>
        </button>

        <button class="btnIcon" id="menuBtn" type="button" aria-label="Menu" title="Menu">
          ☰
        </button>

        <div class="menuPanel" id="menuPanel" aria-hidden="true">
          <!-- <button class="menuItem" id="menuUpload" type="button">NAHRÁNÍ DAT</button> -->
          <button class="menuItem" id="menuNews" type="button">AKTUALITY</button>
          <button class="menuItem" id="menuManagement" type="button">VEDENÍ</button>
          <button class="menuItem" id="menuArticles" type="button">ČLÁNKY</button>
          <!-- <button class="menuItem" id="menuTitles" type="button">TITULY</button>
          <button class="menuItem" id="menuContact" type="button">KONTAKT</button>
          <button class="menuItem" id="menuRecords" type="button">REKORDY</button> -->

          <div class="menuDivider"></div>

          <div class="menuToggleRow">
            <div class="menuToggleLabel">Režim</div>
            <div class="themeToggle" id="themeToggle" title="Přepnout režim">
              <span class="dot"></span>
              <span id="themeLabel">☀️ Světlý</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</header>

<div class="container">
  <div class="heroCarousel" aria-label="Carousel">
    <div class="carouselTrack" id="carouselTrack">
      <img class="carouselImg isActive" src="carousel_1.png" alt="Carousel 1" loading="lazy" />
      <img class="carouselImg" src="carousel_2.png" alt="Carousel 2" loading="lazy" />
      <img class="carouselImg" src="carousel_3.png" alt="Carousel 3" loading="lazy" />
    </div>
    <button class="carouselZone carouselZoneLeft" id="carouselPrev" type="button" aria-label="Předchozí slide"></button>
    <button class="carouselZone carouselZoneRight" id="carouselNext" type="button" aria-label="Další slide"></button>
    <div class="carouselDots" id="carouselDots" aria-hidden="true"></div>
  </div>

  <div class="infoBar" aria-label="Souhrn">
    <div class="infoItem"><b>Medián ELO</b><span id="avgElo">—</span></div>
<div class="infoItem"><b>celkový počet her</b><span id="totalGames">—</span></div>
    <div class="infoItem"><b>unikátní hráči</b><span id="uniquePlayers">—</span></div>
    <div class="infoItem"><b>poslední data</b><span id="lastTournament">—</span></div>
  </div>
</div>

<main>
  <div class="card">
    <div class="toolbar">
      <div class="toolbarSearchRow">
        <input id="search" type="search" placeholder="Hledat hráče…" autocomplete="off" />
      </div>

      <div class="toolbarControlsRow">
        <button id="refresh" type="button">Znovu načíst</button>

        <div class="ratedToggle" title="Zobrazí data z listu Tournament Elo">
          <span class="ratedToggleText">
            <span class="labelFull">Pouze DCPR</span>
            <span class="labelShort">Pouze DCPR</span>
          </span>

          <label class="switch" aria-label="Pouze DCPR">
            <input id="ratedOnly" type="checkbox" />
            <span class="slider" aria-hidden="true"></span>
          </label>
        </div>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="rank colRank">Pořadí</th>
            <th class="playerCol">Player</th>
            <th class="num ratingCol">Rating</th>
            <th class="num colPeak">PEAK</th>
            <th class="num colGames">Games</th>
            <th class="num colWin">Win</th>
            <th class="num colLoss">Loss</th>
            <th class="num colDraw">Draw</th>
            <th class="num colWinrate">Winrate</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <footer>
      <span>Tip: Klikni na jméno hráče pro detail.</span>
      <span>verze: 1.1.0</span>
    </footer>
  </div>
</main>

<script type="module" src="modal.js"></script>
<script type="module">
  const isMobileModal = () => window.matchMedia('(max-width: 760px)').matches;

  // Carousel (placeholder images)
  (function initCarousel(){
    const hero = document.querySelector('.heroCarousel');
    const track = document.getElementById('carouselTrack');
    const dotsWrap = document.getElementById('carouselDots');
    const prevBtn = document.getElementById('carouselPrev');
    const nextBtn = document.getElementById('carouselNext');
    if (!track || !hero) return;

    const imgs = Array.from(track.querySelectorAll('.carouselImg'));
    if (imgs.length < 2) return;

    let i = 0;
    let timer = null;

    // Dots
    let dots = [];
    if (dotsWrap) {
      dotsWrap.innerHTML = '';
      dots = imgs.map((_, idx) => {
        const d = document.createElement('span');
        d.className = 'carouselDot' + (idx === 0 ? ' isActive' : '');
        d.setAttribute('role', 'presentation');
        dotsWrap.appendChild(d);
        return d;
      });
    }

    const setActive = (idx) => {
      imgs.forEach((img, k) => img.classList.toggle('isActive', k === idx));
      if (dots.length) dots.forEach((d, k) => d.classList.toggle('isActive', k === idx));
    };

    const go = (idx) => {
      i = (idx + imgs.length) % imgs.length;
      setActive(i);
    };

    const next = () => go(i + 1);
    const prev = () => go(i - 1);

    const startAuto = () => {
      stopAuto();
      timer = window.setInterval(next, 5200);
    };
    const stopAuto = () => {
      if (timer) {
        window.clearInterval(timer);
        timer = null;
      }
    };

    // Desktop click zones (no visible arrows)
    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        prev();
        startAuto();
      });
    }
    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        next();
        startAuto();
      });
    }

    // Touch swipe (mobile/tablet)
    let startX = 0;
    let startY = 0;
    let dx = 0;
    let dy = 0;
    let isTracking = false;
    let isHorizontal = false;

    const onTouchStart = (e) => {
      if (!e.touches || e.touches.length !== 1) return;
      const t = e.touches[0];
      startX = t.clientX;
      startY = t.clientY;
      dx = 0;
      dy = 0;
      isTracking = true;
      isHorizontal = false;
    };

    const onTouchMove = (e) => {
      if (!isTracking || !e.touches || e.touches.length !== 1) return;
      const t = e.touches[0];
      dx = t.clientX - startX;
      dy = t.clientY - startY;

      // Decide gesture direction once user moves a bit
      if (!isHorizontal) {
        const ax = Math.abs(dx);
        const ay = Math.abs(dy);
        if (ax < 8 && ay < 8) return;
        isHorizontal = ax > ay * 1.15;
      }

      // Prevent vertical scroll when user is swiping the carousel horizontally
      if (isHorizontal) e.preventDefault();
    };

    const onTouchEnd = () => {
      if (!isTracking) return;
      isTracking = false;

      const ax = Math.abs(dx);
      const ay = Math.abs(dy);
      const threshold = 40;
      if (ax > threshold && ax > ay * 1.15) {
        // Swipe left -> next, swipe right -> prev
        if (dx < 0) next();
        else prev();
        startAuto();
      }
    };

    hero.addEventListener('touchstart', onTouchStart, { passive: true });
    hero.addEventListener('touchmove', onTouchMove, { passive: false });
    hero.addEventListener('touchend', onTouchEnd, { passive: true });
    hero.addEventListener('touchcancel', onTouchEnd, { passive: true });

    // Start
    setActive(0);
    startAuto();
  })();

  // Podpořit (QR + účet)
  const supportBtn = document.getElementById('supportBtn');
  if (supportBtn) {
    supportBtn.addEventListener('click', () => {
      const mobile = isMobileModal();

      const bodyHtml = `
        <div class="supportModal">
          <div class="supportHero">
            <div class="supportTitle">Podpořte DC ELO</div>
            <div class="supportBrand">BY GRAIL SERIES</div>
            <div class="supportTagline">Vaše podpora nám pomáhá organizovat lepší turnaje</div>
          </div>

          <div class="supportQrWrap">
            <img class="supportQr" src="QR.png" alt="QR kód" loading="lazy" />
          </div>

          <div class="supportInfo" aria-label="Informace o účtu">
            <div class="supportInfoTitle">INFORMACE O ÚČTU:</div>

            <div class="supportInfoLine">
              <b>Číslo účtu:</b>
              <span class="supportCopy" role="button" tabindex="0" data-copy="2640017029/3030">2640017029/3030</span>
              <span class="supportCopyFeedback" aria-live="polite"></span>
            </div>

            <div class="supportInfoLine">
              <b>IBAN:</b>
              <span class="supportCopy" role="button" tabindex="0" data-copy="CZ03 3030 0000 0026 4001 7029">CZ03 3030 0000 0026 4001 7029</span>
              <span class="supportCopyFeedback" aria-live="polite"></span>
            </div>

            <div class="supportInfoLine">
              <b>BIC (SWIFT):</b>
              <span class="supportCopy" role="button" tabindex="0" data-copy="AIRACZP">AIRACZP</span>
              <span class="supportCopyFeedback" aria-live="polite"></span>
            </div>
          </div>

          <div class="supportNote" aria-label="Poděkování">
            Děkujeme
          </div>
        </div>
      `;

      if (window.openModal) {
        window.openModal({ title: 'Podpořit', subtitle: '', html: bodyHtml, fullscreen: mobile });
      }

// Copy-to-clipboard (support modal) – binding after modal render
      const bindSupportCopy = () => {
        const overlayEl = document.getElementById('modalOverlay');
        if (!overlayEl) return;
        const rootEl = overlayEl.querySelector('.supportModal');
        if (!rootEl) return;

        const doCopy = async (text) => {
          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(text);
              return true;
            }
          } catch (e) {}
          // Fallback
          try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.setAttribute('readonly', '');
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return !!ok;
          } catch (e) {
            return false;
          }
        };

        const showFeedback = (el, ok) => {
          const wrap = el.closest('.supportInfoLine');
          if (!wrap) return;
          const fb = wrap.querySelector('.supportCopyFeedback');
          if (!fb) return;
          fb.textContent = ok ? 'Zkopírováno' : '';
          fb.classList.add('isVisible');
          clearTimeout(fb.__t);
          fb.__t = setTimeout(() => {
            fb.classList.remove('isVisible');
            fb.textContent = '';
          }, 1200);
        };

        const onActivate = async (el) => {
          const text = el.getAttribute('data-copy') || '';
          const ok = await doCopy(text);
          showFeedback(el, ok);
        };

        rootEl.querySelectorAll('.supportCopy').forEach((el) => {
          el.addEventListener('click', () => onActivate(el));
          el.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter' || ev.key === ' ') {
              ev.preventDefault();
              onActivate(el);
            }
          });
        });
      };
      bindSupportCopy();


      const overlay = document.getElementById('modalOverlay');
      if (overlay && !mobile) {
        overlay.classList.add('isSupport');

        const cleanup = () => overlay.classList.remove('isSupport');
        const closeBtn = overlay.querySelector('#closeModalBtn');
        if (closeBtn) closeBtn.addEventListener('click', cleanup, { once: true });
        overlay.addEventListener('click', (ev) => { if (ev.target === overlay) cleanup(); }, { once: true });
        const escHandler = (ev) => {
          if (ev.key === 'Escape') {
            cleanup();
            window.removeEventListener('keydown', escHandler);
          }
        };
        window.addEventListener('keydown', escHandler);
      }
    });
  }

  const link = document.getElementById('anonLink');
  if (link) {
    link.addEventListener('click', (e) => {
      e.preventDefault();

      const mobile = isMobileModal();

      const bodyHtml = `
        <div class="anonModal">
          <h1 class="anonH1">Nechcete být na webu uvedeni?</h1>
          <p>Rozumíme tomu.</p>
          <p>
            Zveřejňovaná data pocházejí z veřejně dostupných zdrojů, od organizátorů turnajů a lig nebo od heren, které s námi spolupracují. Projekt slouží k přehlednému zobrazování těchto informací na jednom místě.
          </p>
          <p>
            Pokud si nepřejete být na webu dohledatelní pod svým jménem, vaše údaje kompletně anonimizujeme, takže vás podle nich již nebude možné identifikovat. Pro anonymizaci vyplňte následující formulář.
          </p>
          <div class="anonActions">
            <a class="btnPrimary btnAnon" href="https://docs.google.com/forms/d/e/1FAIpQLSfwFbnvW9SnOvGZ3KGhk4mHx61GIrWdQBSIp8vGovC1xr9wDg/viewform?usp=dialog" target="_blank" rel="noopener noreferrer">Přejít na formulář</a>
          </div>
        </div>
      `;

      // Modal header
      if (window.openModal) {
        window.openModal({ title: 'Anonimizace', subtitle: '', html: bodyHtml, fullscreen: mobile });
      }

      // Visual tuning for the anonymizace modal only (kept local to the homepage)
      const overlay = document.getElementById('modalOverlay');
      if (overlay && !mobile) {
        overlay.classList.add('isAnon');

        const cleanup = () => overlay.classList.remove('isAnon');

        // Close button
        const closeBtn = overlay.querySelector('#closeModalBtn');
        if (closeBtn) closeBtn.addEventListener('click', cleanup, { once: true });

        // Click outside
        overlay.addEventListener('click', (ev) => { if (ev.target === overlay) cleanup(); }, { once: true });

        // ESC
        const escHandler = (ev) => {
          if (ev.key === 'Escape') {
            cleanup();
            window.removeEventListener('keydown', escHandler);
          }
        };
        window.addEventListener('keydown', escHandler);
      }
    });
  }
</script>
<script type="module" src="aktuality.js"></script>
<script type="module" src="common.js"></script>
<script type="module" src="app.js"></script>
</body>
</html>
